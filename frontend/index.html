<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Portal de Chatbots</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <!-- Contenedor principal del Portal de Chatbots -->
    <main class="chat-container" aria-label="Portal de Chatbots">
      <div class="topbar">
        <h1>Portal de Chatbots</h1>
        <!-- Controles del tema (selector rápido y botón de configuración) -->
        <div class="top-controls">
          <label for="theme-select-quick" class="theme-label">Tema:</label>
          <select id="theme-select-quick" class="theme-select" aria-label="Seleccionar tema"></select>
          <button id="theme-open" type="button" class="btn-link" aria-haspopup="dialog" title="Configurar temas">Configuración</button>
        </div>
      </div>
      <p class="hint">Seleccioná una variante para iniciar una conversación.</p>
      <section id="bot-list" class="chat-log" aria-live="polite"></section>
    </main>
    <!-- Modal de configuración -->
    <!-- Backdrop + modal de parámetros por bot -->
    <div id="settings-backdrop" class="modal-backdrop" hidden>
      <div class="modal" role="dialog" aria-labelledby="settings-title" aria-modal="true">
        <div class="modal-header">
          <h2 id="settings-title">Parámetros</h2>
          <button id="settings-help" type="button" class="btn-link" aria-haspopup="dialog">Help</button>
        </div>
        <p id="settings-feedback" class="hint" role="status" aria-live="polite"></p>
        <form id="settings-form" class="settings-form">
          <fieldset>
            <legend>Generación</legend>
            <label>Temperature <input id="stg-temperature" name="temperature" type="number" step="0.05" min="0" max="2" /></label>
            <label>Top-p <input id="stg-topp" name="top_p" type="number" step="0.05" min="0" max="1" /></label>
            <label>Max tokens <input id="stg-maxtokens" name="max_tokens" type="number" step="1" min="1" max="4096" /></label>
          </fieldset>
          <fieldset>
            <legend>Comportamiento</legend>
            <label><input id="stg-userules" type="checkbox" /> Usar reglas/FAQ</label>
            <label><input id="stg-userag" type="checkbox" /> Usar RAG</label>
            <label><input id="stg-enable-default-rules" type="checkbox" /> Incluir reglas predefinidas del sistema</label>
            <label>
              RAG threshold
              <input id="stg-rag-threshold" name="rag_threshold" type="number" step="0.01" min="0" max="1" />
            </label>
            <label><input id="stg-grounded-only" type="checkbox" /> Solo datos (sin LLM si no hay match)</label>
          </fieldset>
          <fieldset>
            <legend>RAG y Edición</legend>
            <div>
              <button id="btn-rag-json" type="button" class="btn-link">Editor RAG (JSON)…</button>
              <button id="btn-rag-txt" type="button" class="btn-link">Gestor RAG (TXT)…</button>
              <button id="btn-rag-reindex" type="button">Reindexar</button>
            </div>
          </fieldset>
          <fieldset>
            <legend>Ayuda/Menu</legend>
            <label>Plantilla de ayuda/menu
              <textarea id="stg-help-template" rows="4" placeholder="Texto que se devolverá ante 'ayuda' o 'menu'"></textarea>
            </label>
            <div class="modal-actions">
              <button id="stg-help-default" type="button" class="btn-secondary">Usar plantilla por defecto</button>
            </div>
          </fieldset>
          <fieldset>
            <legend>Avanzadas</legend>
            <label>Dominios permitidos (enlaces)
              <input id="stg-allowed-domains" type="text" placeholder="ej.: municipio.gob, municipio.gob.ar" />
            </label>
            <div>
              <button id="btn-intents" type="button" class="btn-link">Editar Intents…</button>
              <button id="stg-allowed-default" type="button" class="btn-secondary" style="margin-left:0.5rem">Usar dominios por defecto</button>
            </div>
          </fieldset>
          <fieldset id="stg-generic-fieldset" hidden>
            <legend>Respuesta genérica (no-match)</legend>
            <label><input id="stg-use-generic" type="checkbox" /> Responder genérico si no hay coincidencia</label>
            <div id="stg-no-match-list" class="suggestions-editor" aria-label="Respuestas genéricas"></div>
            <button id="stg-add-no-match" type="button" class="btn-link">Agregar respuesta genérica</button>
            <label>
              Estrategia
              <select id="stg-no-match-pick">
                <option value="first">Siempre usar la primera respuesta</option>
                <option value="random">Elegir una respuesta al azar</option>
              </select>
            </label>
            <p class="hint">Se usa si el intent es FAQ/Smalltalk sin match de reglas o si el intent es desconocido (unknown), y esta opción está activada.</p>
          </fieldset>
          <fieldset>
            <legend>Instrucciones iniciales (pre-prompts)</legend>
            <div id="stg-preprompts" class="suggestions-editor"></div>
            <button id="stg-add-preprompt" type="button" class="btn-link">Agregar instrucción</button>
          </fieldset>
          <fieldset>
            <legend>Menú (sugerencias)</legend>
            <div id="stg-suggestions" class="suggestions-editor"></div>
            <button id="stg-add-suggestion" type="button" class="btn-link">Agregar sugerencia</button>
            <button id="stg-suggestions-default" type="button" class="btn-secondary" style="margin-left:0.5rem">Usar chips por defecto</button>
          </fieldset>
          <fieldset>
            <legend>Reglas personalizadas</legend>
            <p id="stg-rules-summary" class="hint">Cargando reglas…</p>
            <button id="stg-rules-edit" type="button" class="btn-link">Editar reglas…</button>
            <p class="hint">La edición se realiza en una ventana dedicada. Al guardar o cancelar volverás aquí.</p>
          </fieldset>
          
        </form>
        <div class="modal-actions">
          <button id="settings-save" type="button">Guardar</button>
          <button id="settings-reset" type="button">Restablecer</button>
          <button id="settings-cancel" type="button" class="btn-secondary">Cancelar</button>
        </div>
      </div>
    </div>
    <!-- Editor dedicado de Reglas -->
    <!-- Backdrop + modal exclusivo para reglas personalizadas -->
    <div id="rules-backdrop" class="modal-backdrop" hidden>
      <div class="modal" role="dialog" aria-labelledby="rules-title" aria-modal="true">
        <div class="modal-header">
          <h2 id="rules-title">Editar reglas personalizadas</h2>
        </div>
        <div id="rules-editor-list" class="rules-editor" aria-label="Listado de reglas"></div>
        <div class="modal-actions" style="justify-content: space-between;">
          <button id="rules-add-rule" type="button" class="btn-link">Agregar regla</button>
          <div>
            <button id="rules-save" type="button">Guardar</button>
            <button id="rules-cancel" type="button" class="btn-secondary">Cancelar</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Ayuda de parámetros -->
    <!-- Backdrop + modal de ayuda de parámetros -->
    <div id="help-backdrop" class="modal-backdrop" hidden>
      <div class="modal" role="dialog" aria-labelledby="help-title" aria-modal="true">
        <h2 id="help-title">Ayuda — Parámetros del Chatbot</h2>
        <div class="help-body">
          <p><strong>Generación</strong></p>
          <ul>
            <li><strong>Temperature</strong>: aleatoriedad/creatividad del modelo. 0.6–0.8 (Municipal), 0.8–1.1 (MAR2). Default: 0.7.</li>
            <li><strong>Top‑p</strong>: núcleo de probabilidad. 0.8–0.95 (Municipal), 0.9–1.0 (MAR2). Default: 0.9.</li>
            <li><strong>Max tokens</strong>: longitud máxima de la respuesta. Default: 256.</li>
          </ul>
          <p><strong>Comportamiento</strong></p>
          <ul>
            <li><strong>Usar reglas/FAQ</strong>: activa respuestas fijas (saludos, ayuda, pagos, etc.).</li>
            <li><strong>Usar RAG</strong>: permite buscar en la base `knowledge/faqs/municipal_faqs.json` cuando el intent es RAG.</li>
            <li><strong>RAG threshold</strong>: umbral de similitud (0–1). Recomendado 0.20–0.40. Más bajo = más recall (y posibles falsos positivos); más alto = más precisión (pero puede no devolver resultados).</li>
            <li><strong>Incluir reglas predefinidas</strong>: evalúa tus reglas primero y luego las default del sistema.</li>
            <li><strong>Solo datos</strong>: si está activado, el bot no invoca el LLM cuando no hay match; responde una abstención y sugiere "ayuda".</li>
            <li><strong>Min matches (Reglas)</strong>: en el editor de reglas podés definir cuántas keywords mínimas deben coincidir (k‑de‑n) para activar la regla.</li>
          </ul>
          <p><strong>Orden de decisión</strong></p>
          <ul>
            <li>Reglas (si intent es FAQ/Smalltalk y “Usar reglas” está ON) → RAG (si intent es RAG y “Usar RAG” está ON) → Genérico (si está ON y no hubo match) → LLM.</li>
          </ul>
          <p><strong>Base de conocimiento</strong></p>
          <ul>
            <li>Además de las FAQs (JSON), se indexan textos desde <code>00relevamientos_j2/munivilladata</code> al iniciar la API.</li>
            <li>Tras editar/añadir .txt, reiniciá la API para reindexar.</li>
          </ul>
          <p><strong>Respuesta genérica (no‑match)</strong></p>
          <ul>
            <li>Activá “Responder genérico si no hay coincidencia”. Cargá múltiples frases y elegí estrategia: primera o al azar.</li>
          </ul>
          <p><strong>Reglas personalizadas</strong></p>
          <ul>
            <li>Definí <em>Keywords</em> (separadas por coma), <em>Respuesta</em> y <em>Origen</em> (faq/fallback). No existen “reglas RAG”; RAG es otra etapa.</li>
            <li>Prioridad: tus reglas se evalúan antes que las default si están incluidas.</li>
            <li>La edición de reglas se realiza en una ventana dedicada (“Editar reglas…”).</li>
          </ul>
          <p><strong>Menú (sugerencias)</strong></p>
          <ul>
            <li>Pares etiqueta/mensaje para chips en el cliente Municipal.</li>
          </ul>
          <p><strong>Persistencia</strong></p>
          <ul>
            <li>Se guarda en `chatbots/&lt;id&gt;/settings.json`. “Restablecer” vuelve a los valores estándar.</li>
          </ul>
        </div>
        <div class="modal-actions">
          <button id="help-close" type="button" class="btn-secondary">Cerrar</button>
        </div>
      </div>
    </div>
    <!-- Configuración de tema -->
    <!-- Backdrop + modal de configuración de tema -->
    <div id="theme-backdrop" class="modal-backdrop" hidden>
      <div class="modal" role="dialog" aria-labelledby="theme-title" aria-modal="true">
        <div class="modal-header">
          <h2 id="theme-title">Configuración de tema</h2>
        </div>
        <form id="theme-form" class="settings-form">
          <fieldset>
            <legend>Seleccionar tema</legend>
            <label for="theme-list">Temas guardados</label>
            <select id="theme-list" class="theme-select" aria-label="Temas disponibles"></select>
          </fieldset>
          <fieldset>
            <legend>Editar colores</legend>
            <div class="theme-grid">
              <label>Accent <input id="th-accent" type="color" /></label>
              <label>Accent fuerte <input id="th-accent-strong" type="color" /></label>
              <label>Surface <input id="th-surface" type="color" /></label>
              <label>Surface brillante <input id="th-surface-bright" type="color" /></label>
              <label>Texto primario <input id="th-text-primary" type="color" /></label>
              <label>Texto secundario <input id="th-text-secondary" type="color" /></label>
            </div>
          </fieldset>
          <fieldset>
            <legend>Tipografía</legend>
            <label>Familia de fuente
              <input id="th-font-family" type="text" placeholder="p.ej. Inter, system-ui, sans-serif" />
            </label>
            <label>Tamaño base (px)
              <input id="th-font-size" type="number" min="12" max="24" step="1" placeholder="16" />
            </label>
          </fieldset>
          <fieldset>
            <legend>Visibilidad</legend>
            <label><input id="th-show-mar2" type="checkbox" /> Mostrar modo libre (MAR2) en el portal</label>
          </fieldset>
          <fieldset>
            <legend>Guardar como</legend>
            <label>Nombre del tema <input id="theme-name" type="text" placeholder="p.ej. Municipalidad Azul" /></label>
          </fieldset>
        </form>
        <div class="modal-actions">
          <button id="theme-apply" type="button">Aplicar</button>
          <button id="theme-save" type="button">Guardar</button>
          <button id="theme-update" type="button">Actualizar</button>
          <button id="theme-delete" type="button" class="btn-secondary">Eliminar</button>
          <button id="theme-reset" type="button" class="btn-secondary">Restablecer</button>
          <button id="theme-close" type="button" class="btn-secondary">Cerrar</button>
        </div>
      </div>
    </div>
    <script defer src="portal.js?v=20251107"></script>
  </body>
</html>
    <!-- Modal RAG JSON -->
    <div id="rag-json-backdrop" class="modal-backdrop" hidden>
      <div class="modal" role="dialog" aria-modal="true">
        <div class="modal-header"><h2>Editor RAG (JSON)</h2></div>
        <textarea id="rag-json-editor" style="width:100%;height:50vh" aria-label="RAG JSON"></textarea>
        <div class="modal-actions">
          <button id="rag-json-load" type="button">Cargar</button>
          <button id="rag-json-save" type="button">Guardar</button>
          <button id="rag-json-close" type="button" class="btn-secondary">Cerrar</button>
        </div>
      </div>
    </div>

    <!-- Modal RAG TXT -->
    <div id="rag-txt-backdrop" class="modal-backdrop" hidden>
      <div class="modal" role="dialog" aria-modal="true">
        <div class="modal-header"><h2>Gestor RAG (TXT)</h2></div>
        <div id="rag-txt-list" class="help-body"></div>
        <label>Archivo nuevo
          <input id="rag-txt-name" type="text" placeholder="ej.: mi_texto.txt" />
        </label>
        <textarea id="rag-txt-content" style="width:100%;height:30vh" placeholder="Contenido .txt"></textarea>
        <div class="modal-actions">
          <button id="rag-txt-upload" type="button">Subir/Guardar</button>
          <button id="rag-txt-delete" type="button" class="btn-secondary">Eliminar seleccionado</button>
          <button id="rag-txt-close" type="button" class="btn-secondary">Cerrar</button>
        </div>
      </div>
    </div>

    <!-- Modal Intents -->
    <div id="intents-backdrop" class="modal-backdrop" hidden>
      <div class="modal" role="dialog" aria-modal="true">
        <div class="modal-header"><h2>Editor de Intents</h2></div>
        <textarea id="intents-editor" style="width:100%;height:50vh" placeholder='{"patterns": [{"intent":"rag","keywords":["tramit","online"],"confidence":0.65}]}'></textarea>
        <div class="modal-actions">
          <button id="intents-load" type="button">Cargar</button>
          <button id="intents-save" type="button">Guardar</button>
          <button id="intents-close" type="button" class="btn-secondary">Cerrar</button>
        </div>
      </div>
    </div>
